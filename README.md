# 4.2补充需求
@(产品)[朴茶收银,M2O门店管理工具]

---
[toc]

## 约定
--- 
名词|解释
:---|:---
零售价|取商品的销售价格
特价|醉品配置的商品特价
会员价|以某个会员等级（或者是游客）作为客户，可以获取的商品价格
商品小计|某款商品的会员价*数量
商品总计|商品小计之和
整单优惠|整个订单优惠的金额
应收金额| 应收金额=商品总计-整单优惠


## 退款功能优化

进货单状态|
:---|
待审核（预留） |
待发货 |
已发货|
已完成|
退款成功|


退款单状态|
:---|
待审核 |
审核通过，退款中 |
退款成功|
审核通过，请退货|
已退回，待收货|
已收货，确认中|
退款关闭|


	
退款类型|
:---|
整单退款 |
（空） |
仅退款|
退货退款|


##4.2期-PC【前-忘记密码】
---
###step1
![Alt text](./1505759764900.png)
1.  图形尺寸参考UI图
2. 用户名，限制输入为1开头的11位数字，忽略其他输入。输入符合规则，并且满11位数字时，去校验输入的手机号码![Alt text](./1505759956131.png)
当不是收银项目的用户，提示出错![Alt text](./1505760050127.png)（文字：很抱歉，该手机号尚未开通，若已更换手机，请联系醉品客服或运营人员。客服电话：4006-066-068）
当输入的手机号符合规则，且是收银系统的的账号，提示正确![Alt text](./1505760171335.png)
3. 图形验证码
图形验证码规则为5位数字和英文字符混合，避开1li，0o易混淆的字符，输入框限制输入5位数字和英文字符，忽略其他输入。
4. 获取短信验证码
当手机号和短信验证码输入符合规则后，按钮变成可点击状态（文字#1B8FFF，背景色：#fff,border:#1B8FFF 1px，圆角5px）
点击后如果验证码错误，验证码做提示。![Alt text](./1505760774266.png)
如果没问题，可以获取修改密码短信验证码，并在页面做倒计时60s。


###step2
![Alt text](./1505765424458.png)

1. 新密码
密码格式需为6-16位的数字、字母和特殊字符。当输入框失去焦点时，去校验格式。若格式不正确，则在输入框右侧，做错误提醒，提示内容：“请输入6-16位的数字或字母或特殊字符”
2. 两次输入密码要一致，如果错误在第二个输入框右侧做错误提示，提示内容：“两次密码不一致”   
3. 当全部栏位校验正确时，【下一步】按钮亮起；否则呈现灰色；（参考登录的色值）

###step3
![Alt text](./1505765960705.png)
设置成功，需要返回登录页面重新登录。



## 4.1期相关优化
###登录页面
---


### 收银台
---
#### 选择商品
- 【BUG】商品结果只能显示一页
- 可点击范围优化
> ![Alt text](./1505652131356.png)
> 选择商品界面，可点击范围需要扩大到整行


- 搜索按钮位置与UI图不一致
- 鼠标在输入框时，输入enter，能执行搜索动作
- 第一行内容和表头的间距
- hover的色值与UI图不一致
- 规格多了一个g
- 规则过长没有隐藏字符


#### 收银界面
- 【BUG】规格取值有问题
> ![Alt text](./1505654174903.png)
- 商品列表的hover色值与UI不同
- 商品列表的底部多出一个padding和一根横线
- 商品列表的外框底部少一个2像素的border
> ![Alt text](./1505658588018.png)

- 数量的样式与UI不同。可输入状态不清晰
- 会员部分姓名如果超出长度，需要...显示，鼠标悬停才显示
> ![Alt text](./1505697239512.png)

- 会员手机号输入限制11位数字
- 点击新增会员的按钮，在弹窗，需要把输入的手机号带入弹窗的手机号中
- 整单优惠（整单折扣）在用户输入的时候，就做实时检验和显示
- 整单折扣底下有一行提示文字，缺少了。 整单折扣在激活的时候显示


#### 收银台结算页面
- 输入现金的输入框样式，参考UI图做优化，并且对输入长度限制为5位整数+2位小数。只能输入数字和小数点，实时判断，忽略其他键输入。
- 找零的显示，在关闭结算页面，再重新开时候，需要重置。
> ![Alt text](./1505663116687.png)

- 支付方式的角标在不同屏幕大小时，会出现不对齐边框的情况
> ![Alt text](./1505697997446.png)


- 选其他支付方式时候，现金的找零也需要隐藏，高度最好也能快速动画向上收缩
> ![Alt text](./1505660879687.png)

- 【系统功能】抹零功能保留，但是抹零的金额，在最终收款并确认后，合并到优惠的金额中。并在相关的报表，不单独体现抹零字段。（后面的文档会单独标注出）
- 底部提示内容做优化
	- 商品总额：取商品的总额
	- 优惠：优惠金额
	- 应收金额：=商品总额-优惠
> ![Alt text](./1505661136718.png)

- 打印小票后，收银台页面需要重置（不论打印成功与否）

### 销售退款
---
**界面图：**
![Alt text](./1505766361062.png)

1. 小票输入&查询弹窗
用户可以根据小票输入数值来做查询，当输入值查询 不到结果时候，toast提示出错，内容为：“无法查询到小票”，2秒后消失。
当输入值查询到一条结果时，可以直接带出销售单到退款界面，可退某款商品为0时，则不显示这条商品记录
当输入值查询到一条结果，并且是已经全部退款的销售单时，toast提示出错，内容为：“该小票已经全部退款”
当输入值查询到多余一条结果时，弹窗出现查询结果页面，并引导用户选择
![Alt text](./1505766680953.png)

- 搜索框是带入上一层页面的输入框内容。
- 订单状态
需要标记处该订单是否有过退款，如果有，是部分退款，还是全部退款（标示为已退款），已退款时，无法选择该订单。
- 小票编号
- 销售时间（精确到时分秒）
- 会员账号
显示销售单对应的会员账号（如果是游客，则用“-”显示）
- 会员姓名
如果是游客，则显示“游客”
- 实收金额
取订单的金额
- 详情
点击可以在新开窗口显示具体订单的详情
- 选择订单的触发范围，需要扩展到整行，不局限只有checkbox



2. 退款结算页面
![Alt text](./1505769344429.png)

列表界面优化：
- 删除类别字段
- 删除零售价字段
- 删除结算单价字段
- 删除会员字段
- 删除会员手机字段
- 新增会员价：取商品的会员价
- 数量
默认值为客户下单时的数量-已退货的商品，用户修改只能修改为1~默认值之间的数值，忽略其他输入
用户输入（修改）时，如果不符合规则，实时反馈输入结果（和现有线上的一致）
如果可退数量为0，则不显示在列表中。
- **整单优惠：**收银时，整单优惠的金额，按商品小计进行分摊的金额。显示为负数，计算的大逻辑是`如果退款数量不是全部退，则整单优惠以退款数量/总数量进行分摊`
这里的计算逻辑是：
	- 没发生退款时， `整单优惠X = round(商品小计/商品总计 * 整单优惠) `  。最后一款商品：`整单优惠（最后一款） = 优惠总额 - 其他商品优惠金额`。如果用户勾选，并修改数量小于可退数量，则`整单优惠Y=round(整单优惠X/商品总数量*用户要退款的数量)`
	- 如果发生过部分退款，`整单优惠Z = 原始整单优惠X - 整单优惠Y1 - 整单优惠Y2...整单优惠Yn`，如果用户勾选，并修改数量小于可退数量，则`整单优惠 = round(整单优惠X/商品总数量*用户要退款的数量)`
- 商品小计 ，`这里的商品小计=商品会员价*退款数量-计算出的整单优惠`
- 退款数量 是勾选的需要退款的数量
- 共计：勾选需要退款的商品小计
> 我们举个栗子：
> |商品名称|单价|数量|小计
> |:---|--:|--:|--:|
> |商品A|80.00|2|160.00
> |商品B|37.51|3|112.53
> |商品C|42.49|3|127.47
> |||合计|400.00
> 整单优惠了94.81%，400*94.81% = 379.24，抹零0.24元，实收379元，共优惠了21元。21元的分摊到ABC三款商品分别是：
>  |商品名称|分摊公式|分摊值（上文提到的整单优惠X）|备注
> |:---|:--|--:|
> |商品A| 160 / 400 * 21|8.4|
> |商品B| 112.53 / 400 * 21|5.92 |(实际等式算出来是5.91，因为5.91可以被3整除，所以我们假装是5.92)
> |商品C| 21 - 8.4 - 5.92|6.68|
> 此时我们做第一次退款，A退1个，B退1个，C退2个，套用我们的公式，
> |商品名称|整单优惠Y的计算公式|整单优惠Y|应退小计|备注
> |:---|:--|--:|--:|:--
> |商品A| ( 8.4 / 2 * 1)|4.2|80 - 4.2 = 75.8|
> |商品B| ( 5.92 / 3 * 1)|1.97|37.51 - 1.97 = 35.54|保留2位小数四舍五入|
> |商品C| (6.68 / 3 * 2)|4.45|42.49 * 2 - 4.45 = 80.53|保留2位小数四舍五入|
> 应退共计：191.87   
> 设置整单少退：91.87
> 实际退款：100元
>  
> 此时我们再做一次退款，只退商品B，退2个，因为剩余的数量全部退，则计算公式为：
> |商品名称|分摊公式|分摊值（上文提到的整单优惠Z）|备注
> |:---|:--|--:|
> |商品B|整单优惠X(5.92) - 整单优惠Y(1.97)|3.95|
> 应退金额 = 会员价(37.51) * 退款数量(2) - 整单优惠Z(3.95) = 71.07
>    

新增会员模块：
- 根据小票获取对应的会员信息，只做展示用，不参与实际计算（会员的折扣，已经体现在表格中 的会员价）
如果是游客，会员手机显示为“-”

新增整单少退：
- 操作人员，可以根据实际退款情况，做退款金额的调整，这里的取值范围从`[0~共计]`，忽略其他非数字输入，输入后实时做校验，如果大于共计，toast出错提示内容：少退金额不能大于应退金额！

优化应退金额：
- 应退金额计算公式为：`应退金额=共计-整单少退`

优化退款按钮：
- 允许用户选择退款账户，默认勾选订单支付时，使用的支付方式
> ![Alt text](./1505781109518.png)

- 底部的`商品应退=共计`  `整单少退=整单少退`  `应退金额=商品应退-整单少退`
- 如果变更支付方式，会导致部分结算账户为负数，需要支持

### 销售数据
---
####收银订单详情
![Alt text](./1505781410298.png)
- 删除抹零展示，抹零的金额与优惠的金额合并计算并展示

